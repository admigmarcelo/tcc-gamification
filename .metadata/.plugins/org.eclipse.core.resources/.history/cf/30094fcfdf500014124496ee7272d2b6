'use strict';
var appModule = angular.module('app', [ 'ngRoute', 'ngResource', 'ui.bootstrap' ]);

var appModule = angular.module('app').factory('Usuario', function ($resource) {
    return $resource('http://localhost:8080/TCC-GamificationJava/usuario/:login', {}, {
        query: { method: "GET", isArray: true },
        'update': { method: 'PUT'}
    });

});

var appModule = angular.module('app').factory('Login', function ($resource) {
    return $resource('http://localhost:8080/TCC-GamificationJava/usuario/login');
});

var appModule = angular.module('app').factory('Progresso', function ($resource) {
    return $resource('http://localhost:8080/TCC-GamificationJava/progresso/:progresso/nivel/:nivel');
});

var appModule = angular.module('app').factory('Modulo', function ($resource) {
    return $resource('http://localhost:8080/TCC-GamificationJava/modulo/:modulo/assunto/:assunto/exercicio/:exercicio', {}, {
        query: { method: "GET", isArray: true }
    });
});

appModule.factory('usuario', function () {

    var data = {};

    return {
        getUsuario: function () {
            return data;
        },
        setUsuario: function (usuario) {
            data = usuario;
        },
    };
});

appModule.controller('LoginController', function ($rootScope, $scope, $http, $location, usuario, Login) {
    $rootScope.activetab = $location.path();
    $scope.usuario = {
        "login": "",
        "senha": ""
    };
    $scope.mensagem = "";

    $scope.logarUsuario = function () {
        var data = $scope.usuario;
        Login.save(data, function (response) {
            var status = response.retorno;
            if (status === true) {
                usuario.setUsuario($scope.usuario);
                $location.path('/home');
                $location.replace();
            } else {
                $scope.mensagem = "UsuÃ¡rio ou senha incorreto";
                console.log(status);
            }
        });

    };
});

appModule.controller('UsuarioController', function ($rootScope, $location, $scope, $http, usuario, Usuario, Progresso) {
    $rootScope.activetab = $location.path();
    $rootScope.usuarioLogado = usuario.getUsuario().login;
    $scope.usuario = {};
    Usuario.query(function (data) {
        $scope.usuariosTop = data;
    });

    Usuario.get({ login: usuario.getUsuario().login }, function (data) {
        $scope.usuario = data;
        usuario.setUsuario($scope.usuario);
        
        Progresso.get({ nivel: $scope.usuario.nivel.id }, function (data) {
            var proxNivel = data;
            if(proxNivel != null){
	            var percentMaxima =  proxNivel.pontos - $scope.usuario.nivel.pontos;
	            var percentAtual = $scope.usuario.pontos - $scope.usuario.nivel.pontos;
	            var resultPercent = (percentAtual / percentMaxima) * 100;
	            $scope.percentNivel = parseInt(resultPercent.toFixed(0));
            }else{
            	$scope.percentNivel = 100;
            }
        });
    });
    
    

});

appModule.controller('ModuloController', function ($rootScope, $location, $scope, Modulo, ExerciciosFactory, usuario) {
    $rootScope.activetab = $location.path();
    var modulos = [];
    $scope.modulos;
    var progressos = usuario.getUsuario().progressos;
    progressos = progressos.sort();
    var contador = 0;
    $scope.progresso = progressos[progressos.length - 1];
    var contExercicioPorAssunto = [];
    for(var p in progressos){
    	var progresso = progressos[p];
    	contador += 1;
    	var progr = progressos[contador];
    	if(progresso.exercicio.assunto.id != progr.exercicio.assunto.id){
    		contExercicioPorAssunto.push({'assuntoId': progresso.exercicio.assunto.id, 'total': contador});
    		contador = 0;
    	}
    }
    console.log(contExercicioPorAssunto);
    
    Modulo.query()
    .$promise.then(function(data) {
    	$scope.modulos = data;
    	modulos = data;
    });
    
    $scope.teste = function () {
    	var contExercicioPorAssunto = [];
    	var assuntos = [];
    	for(var p in modulos){
    		assuntos = modulos[p].assuntos;
    		for(var a in assuntos){
        		var assunto = assuntos[a];
        		if(assunto.exercicios.length === 0 && assunto.conquistas.length > 0){
        			assunto.total = 1;
        		}
        		else{
        			contExercicioPorAssunto.push(assunto.exercicios.length); 
        			assunto.total = assunto.exercicios.length;
        		}
        		console.log(assunto.total);
        	}		
    	}
    	console.log(contExercicioPorAssunto);
    	
    };
    $scope.percentual = [];
    $scope.escolherAssunto = function (assunto, index) {
    	for(var c in contExercicioPorAssunto){
    		var assuntoProgresso = contExercicioPorAssunto[c];
    		if(assunto.id == assuntoProgresso.assuntoId){
    			$scope.percentual[index] = (assuntoProgresso.total / assunto.exercicios.length) * 100;
    		}else
    			$scope.percentual[index] = 0;
    	}
    	
//        if (assunto.modulo.nome == "UML") {
//            Modulo.query({ assunto: assunto.id }, function (data) {
//                ExerciciosFactory.setExercicios(data);
//                ExerciciosFactory.setBadges(assunto.conquistas);
//                ExerciciosFactory.setProxEx(0);
//                $location.path("/uml/exercicios");
//            });
//        } else {
//            Modulo.query({ assunto: assunto.id }, function (data) {
//                ExerciciosFactory.setExercicios(data);
//                ExerciciosFactory.setBadges(assunto.conquistas);
//                ExerciciosFactory.setProxEx(0);
//                $location.path("/java/exercicios");
//            });
//        }

    };

});

appModule.controller('CadastroController', function ($scope, $http, Usuario) {
    $scope.usuario = {
        "nome": "",
        "login": "",
        "senha": ""
    };
    $scope.mensagem = "";
    $scope.status = "";

    $scope.cadastrarUsuario = function () {
        var data = $scope.usuario;
        Usuario.save(data, function (response) {
            //data saved. do something here.
        }); //saves an entry. Ass
    };

});

